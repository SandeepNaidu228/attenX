<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <title>Attendance Page</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="attendance-container">
        <h2>Your Attendance Details</h2>

        <div class="attendance-summary">
            <p class="info">Here is your class attendance summary:</p>
            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>Course Name</th>
                        <th>Total Classes</th>
                        <th>Classes Attended</th>
                        <th>Attendance (%)</th>
                        <th>Mark Attendance</th>
                        <th>View Details</th>
                    </tr>
                </thead>
                <tbody id="attendance-body">
                    <!-- Courses will be loaded here -->
                </tbody>
            </table>
            <p id="no-courses" class="info">No courses added yet. Add courses from the Manage Courses page.</p>
        </div>

        <div class="action-buttons">
            <button class="attendance-btn" onclick="window.location.href='manage_courses.html'">Manage Courses</button>
            <button class="attendance-btn" onclick="window.location.href='index.html'">Logout</button>
        </div>
    </div>

    <!-- Mark Attendance Modal -->
    <div class="modal" id="markAttendanceModal">
        <div class="modal-content">
            <span class="close" onclick="closeMarkAttendanceModal()">&times;</span>
            <h3>Mark Attendance for <span id="mark-course-name"></span></h3>
            <div class="input-group">
                <label for="attendance-date">Date:</label>
                <input type="date" id="attendance-date" required>
            </div>
            <div class="input-group">
                <label for="attendance-status">Status:</label>
                <select id="attendance-status" required>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                </select>
            </div>
            <button class="action-btn" onclick="saveAttendance()">Save Attendance</button>
            <p id="modal-error" class="error-message"></p>
        </div>
    </div>

    <!-- Attendance Records Portal -->
    <div class="modal" id="attendancePortal">
        <div class="modal-content attendance-portal">
            <span class="close" onclick="closeAttendancePortal()">&times;</span>
            <h3>Attendance Records for <span id="portal-course-name"></span></h3>
            <div class="attendance-records" id="attendance-records">
                <!-- Attendance records will be loaded here -->
            </div>
            <button class="action-btn" onclick="closeAttendancePortal()">Close</button>
        </div>
    </div>

    <script>
        // Load and display courses
        function loadCourses() {
            const courses = JSON.parse(localStorage.getItem('courses')) || [];
            const tbody = document.getElementById('attendance-body');
            const noCourses = document.getElementById('no-courses');
            
            tbody.innerHTML = '';
            
            if (courses.length === 0) {
                noCourses.style.display = 'block';
                return;
            }
            
            noCourses.style.display = 'none';
            courses.forEach(course => {
                const attendanceRecords = course.attendanceRecords || [];
                const totalClasses = attendanceRecords.length;
                const attendedClasses = attendanceRecords.filter(record => record.status === 'present').length;
                const percentage = totalClasses > 0 ? ((attendedClasses / totalClasses) * 100).toFixed(1) : '0.0';
                
                const row = `
                    <tr>
                        <td>${course.name}</td>
                        <td>${totalClasses}</td>
                        <td>${attendedClasses}</td>
                        <td>${percentage}%</td>
                        <td><button class="edit-btn" onclick="openMarkAttendanceModal('${course.id}')">Mark Attendance</button></td>
                        <td><button class="edit-btn" onclick="openAttendancePortal('${course.id}')">View Details</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function openMarkAttendanceModal(courseId) {
            const courses = JSON.parse(localStorage.getItem('courses'));
            const course = courses.find(c => c.id === courseId);
            
            document.getElementById('markAttendanceModal').style.display = 'flex';
            document.getElementById('mark-course-name').textContent = course.name;
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-status').value = 'present';
            window.currentCourseId = courseId;
        }

        function closeMarkAttendanceModal() {
            document.getElementById('markAttendanceModal').style.display = 'none';
            document.getElementById('modal-error').textContent = '';
            window.currentCourseId = null;
        }

        function saveAttendance() {
            const attendanceDate = document.getElementById('attendance-date').value;
            const attendanceStatus = document.getElementById('attendance-status').value;
            const courses = JSON.parse(localStorage.getItem('courses'));
            const course = courses.find(c => c.id === window.currentCourseId);
            
            if (!attendanceDate) {
                document.getElementById('modal-error').textContent = 'Please enter a valid date';
                return;
            }

            if (!course.attendanceRecords) {
                course.attendanceRecords = [];
            }

            // Check if an entry for this date already exists
            const existingIndex = course.attendanceRecords.findIndex(record => record.date === attendanceDate);
            if (existingIndex !== -1) {
                // Update existing record
                course.attendanceRecords[existingIndex].status = attendanceStatus;
            } else {
                // Add new record
                course.attendanceRecords.push({
                    date: attendanceDate,
                    status: attendanceStatus
                });
            }

            // Sort records by date
            course.attendanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            localStorage.setItem('courses', JSON.stringify(courses));
            loadCourses();
            closeMarkAttendanceModal();
        }

        function openAttendancePortal(courseId) {
            const courses = JSON.parse(localStorage.getItem('courses'));
            const course = courses.find(c => c.id === courseId);
            
            document.getElementById('attendancePortal').style.display = 'flex';
            document.getElementById('portal-course-name').textContent = course.name;
            
            const recordsContainer = document.getElementById('attendance-records');
            recordsContainer.innerHTML = '';
            
            if (!course.attendanceRecords || course.attendanceRecords.length === 0) {
                recordsContainer.innerHTML = '<p>No attendance records found for this course.</p>';
                return;
            }
            
            course.attendanceRecords.forEach((record, index) => {
                const recordElement = document.createElement('div');
                recordElement.className = 'attendance-record';
                recordElement.innerHTML = `
                    <span class="record-date">${record.date}</span>
                    <select class="record-status" onchange="updateAttendanceStatus('${courseId}', ${index}, this.value)">
                        <option value="present" ${record.status === 'present' ? 'selected' : ''}>Present</option>
                        <option value="absent" ${record.status === 'absent' ? 'selected' : ''}>Absent</option>
                    </select>
                `;
                recordsContainer.appendChild(recordElement);
            });
        }

        function closeAttendancePortal() {
            document.getElementById('attendancePortal').style.display = 'none';
        }

        function updateAttendanceStatus(courseId, recordIndex, newStatus) {
            const courses = JSON.parse(localStorage.getItem('courses'));
            const course = courses.find(c => c.id === courseId);
            
            course.attendanceRecords[recordIndex].status = newStatus;
            
            localStorage.setItem('courses', JSON.stringify(courses));
            loadCourses();
        }

        // Initialize the page
        window.onload = loadCourses;
    </script>
</body>
</html>

